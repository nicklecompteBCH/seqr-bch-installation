{% extends 'analysispage.html' %}
{% load x_extras %}
{% load static from staticfiles %}


{% block title %}<p><i>Search in</i>&nbsp: The Matchmaker Exchange</p>{% endblock %}

{% block links %}
<!-- Jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
 
<!--  tables -->
<script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css"/>
<!--  font awesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

<script>
$(document).ready(
		function(){
			$('#mmeResultsContainer').hide();
			var base = window.location;
			var urlFields = new String(base).split("/");
			var projectId=urlFields[urlFields.length-3];
			var familyId=urlFields[urlFields.length-1];
			sessionStorage.projectId=projectId;
			sessionStorage.familyId=familyId;
			$('#projId').text(projectId);
			$('#familyId').text(familyId);
			//update title href's as well
			$('#projectIdA').attr('href',"/project/"+projectId);
			$('#familyIdA').attr('href',"/project/" + projectId + "/family/"+familyId);
			startSearch();
		});
</script>
Project: <a id="projectIdA" href=""><span id="projId"></span></a>
Family: <a id="familyIdA" href=""><span id="familyId"></span></a>

{% endblock %}
{% block innercontent %}
{% include 'javascript.html' %}
{% include 'family_warnings.html' %}
        
<div class="container">
	<div class="row" id="search-warning-messages"></div>
	<div class="row" id="mmeLastSubmissionContainer"></div>
	<div class="row" id="mmeResultsContainer">
		<div id="loading-in-progress-message" style="display:none;">
    		<h4>We are searching the Matchmaker network, this may take a few seconds....<i class="loading-in-progress fa fa-spinner fa-spin fa-3x fa-fw"></i></h4>
		</div>
	</div>

 	<!---------------------------- Detailed result MODAL-------------------->
 	<div id="detailedResuleModal" class="modal fade" role="dialog" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title">Detailed result</h4>
                    <div id="mmeModalContent">
                    
                    <h4 class="section-header">Match results</h4>
                    <div id="detailedResultContainer"></div>
                    
                    </div>
                </div>
                <div class="modal-body"></div>
        </div>
    </div>
    </div>
    
    
    <!---------------------------- Detailed gene info MODAL-------------------->
    <div id="geneInfoModal" class="modal fade" role="dialog" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
            	<div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 id="info-modal-header" class="modal-title section-header">Detailed gene information</h4>
            	</div>
            	<div class="modal-body">
            		<iframe id="geneInfoIframe" width="100%" height="100%" src="" frameborder="0"></iframe>
            	</div>
        </div>
    </div>
    </div>
    
     <!---------------------------- Error MODAL-------------------->
	 <div id="stateUpdateErrorModal" class="modal fade" role="dialog">
	  <div class="modal-dialog">
	    <!-- Modal content-->
	    <div class="modal-content">
	      <div class="modal-header" id='messageModalHeader'>
	        <h4 class="modal-title">Sorry, we experienced an error</h4>
	      </div>
	      <div id="modalBody">
	      	<p><h4 class="error-modal-content">We couldn't update our database for some reason, sorry about that, could you please try again in a little bit or contact us for help.</h4></p></div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	      </div>
	    </div>
	  </div>
	 </div>


  	<!---------------------------- Update submission MODAL-------------------->
  	<div id="updateSubmissionModal" class="modal fade" role="dialog">
  	<div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header" id='updateSubmissionModalHeader'>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Submit to the Matchmaker Exchange</h4>
      </div>
      <div id="updateSubmissionModalBody">
      	   <div id="individualsToSubmit">
      	   		<div id="no-submission-found-message"></div>
      	   		<dl>You are about to submit patient information to the matchmaker exchange, the information submitted will be shared within this <a href="http://www.matchmakerexchange.org/">matchmaker</a> network. The individual ID will be replaced by another unique value in order to obfuscate it.</dl>
				<dl>Please note our disclaimer can be found <a href="/matchmaker/disclaimer">here</a>.</dl>	
      	   </div>	 
      	   <div id="submissionCandidatesContainer" style="display:none;">   
      	   	   <label>Please select what you would like <strong>submit-to</strong> and <strong>search-with</strong> in the Matchmaker Exchange</label> 
		       <div id="genotypeSubmissionCandidateInfo"></div>
			   <div id="phenotypeSubmissionCandidateInfo"></div>
			<div>
				<button type="button" class="btn btn-primary" onclick="showDataToBeSubmitted();" id="continueWithsubmission">Continue with submission</button>
			</div>
		  </div> 
		  <div id="dataToBeSubmittedReceiptContainer"  style="display:none;">
				<div id="dataToBeSubmittedReceipt"></div>
				<button type="button" id="submitIndividualBtn" class="btn btn-primary finalSubmissionData">Submit this individual</button>
		  </div>
      </div>
      <div class="modal-footer">
        <button id="add-to-matchbox-modal-close-btn" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
 </div>

 <!---------------------------- submission state MODAL-------------------->
 <div id="submissionStateMessageModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" id='submissionStateMessageModalHeader'>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Matchmaker Exchange at the Broad Institute</h4>
      </div>
      <div id="submissionStateMessageModalModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" onclick="$('#add-to-matchbox-modal-close-btn').click(); startSearch();" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
 </div> 
</div>			

 
<script>
/**
* Click handlers
*/ 
		function processDetailedDisplay(id){
			var patient = JSON.parse(sessionStorage.results)[id];
			addPatientToModal(patient);
	        $('#detailedResuleModal').modal('show');	
		}
		
		
		function showGeneInfoDisplay(geneId){
			var geneCardUrl='/gene/' + geneId;
			$('#geneInfoIframe').attr('src', geneCardUrl);
	        $('#geneInfoModal').modal('show');	
		}
		
		
		/**
		 * Go back to family page
		 */
		$('#goBackBtn').click(
				function start(){
					var href="/project/" + sessionStorage.projectId + "/family/"+ sessionStorage.familyId;
					window.location=href;
				});
	
/**
 * Send a HTML markup for message saying no patients are submitted
 */
function getNoPatientsToSearchWithMessage(){
	html  = '<div class="alert alert-danger" role="alert"><p>Sorry, <strong>I could not find any submissions</strong> from this family. You would need to first <strong>submit</strong>';
	html += ' this family to matchmaker to be able to search with it. ';
	html += 'If you have any questions, please contact <strong><a href="mailto:matchmaker@broadinstitute.org">matchmaker@broad</a></strong> for help. Otherwise, please follow instructions below to submit an individual to search with';
	return html;	
}


/**
 * Start searching MME
 */
function startSearch(){
		$('#mmeMatchResultTbl tbody').empty();
		var url = '/api/matchmaker/last_submission/project/' + sessionStorage.projectId + '/family/' + sessionStorage.familyId ;
		$.ajax({url: url, 
			 	success: function(result){
			 		if (result['family_submissions'].length==0){
			 			$('#no-submission-found-message').append(getNoPatientsToSearchWithMessage());
			 			startORUpdateASubmitionToMME();
				 		return;
			 		}
					$('#mmeResultsContainer').show();
					$('#search-warning-messages').empty();
					var headersSet=false;
					var deletedIndividualsCount=0;
			 		for (var i=0; i<result['family_submissions'].length;i++){
					 		if (result['family_submissions'][i].hasOwnProperty('deletion') && result['family_submissions'][i]['deletion']!= null){
					 			console.log("this individual was deleted:")
								console.log(result['family_submissions']);
					 			deletedIndividualsCount++;
					 		}
					 		else{
					 			if (!headersSet){
					 				setupLastSubmissionTableHeaders();
					 				headersSet=true;
					 			}
								renderSubmittedData(result['family_submissions'][i]['submitted_data'],
													result['family_submissions'][i]['hpo_details'],
													result['family_submissions'][i]['seqr_id']);
								searchInMME(result['family_submissions'][i]['submitted_data'],
											result['family_submissions'][i]['seqr_id'],
											sessionStorage.projectId);
					 		}
			 		}
			 		if (deletedIndividualsCount==result['family_submissions'].length){
			 			$('#no-submission-found-message').append(getNoPatientsToSearchWithMessage());
			 			startORUpdateASubmitionToMME();
			 		}
			 	},
			 	error:function(){
			 	},
			    async:false,  
		 });
	}
	
/**
 * Renders that last submitted patient on top of the results table
 */
function renderSubmittedData(individual,hpo_details,seqr_id){
	var html='<tr>';
	
	html += '<td>' + seqr_id + '</td>';
	
	html += '<td>';
	var asyncGeneId='';
	var geneId='';
	for (var i=0; i<individual['patient']['genomicFeatures'].length; i++){
		geneId=individual['patient']['genomicFeatures'][i]['gene']['id'];
		if (geneId.search('ENSG')==0){
			var asyncGeneId='lastSubAsyncGene_' + i.toString();
			html += '<div id="'+ asyncGeneId + '"></div>';
			addHgncToEnsembl(geneId, asyncGeneId);			
		}
		else{
			html += geneId;
		}	
		html += '<br>';
	}
	html += '</td>';
	html += '<td>';
	for (var i=0; i<individual['patient']['features'].length; i++){
		html += hpo_details[individual['patient']['features'][i]['id']]['name']
		html += '&nbsp&nbsp(';
		html += individual['patient']['features'][i]['id'];	
		html += ')';
		html += '<br>';
	}
	html += '</td>';
	
	html += '</tr>';
	$('#mmeLastSubmissionTbl tbody').append(html);
}

</script>


<style>
th.sorting{
    font-weight: normal;
}

#geneInfoIframe {
    height: 600px;
}

#phenotypeInfoIframe{
    height: 600px;
}


tr.result_seen_before{
	/**background-color:lightgrey !important;**/
}

tr.new_result{
	background-color:yellow !important;
}

input[type="checkbox"] {
  transform:scale(2, 2);
}

input[typ="text"] .match-comments{
	width:100%;
	height:600px;
}

.save-comment-btn{
	margin-top:10px;
}

.error-modal-content{
	margin-left:18px;
}

#updateSubmissionModalBody{
	margin-left:18px;
	margin-right:18px;
	margin-top:18px;
}

.modal-body {
    overflow-y: auto;
}

#submissionStateMessageModalModalBody{
	margin:40px;
	margin-left:18px;
	margin-right:18px;
	margin-top:18px;
}

.phenotype-observed-yes{
	color: green;
}

.phenotype-observed-no{
	color: red;
}

.submissionCandidateTable-variant-column {
  min-width: 200px;
  width: 200px;
  max-width: 200px;
}


</style>
<script>
/**
 * Display a no matches found alert
 */
function showNoMatchMessage(seqrId){
	var html = '<div class="alert alert-danger" role="alert">'; 
	html +="Sorry, we were <strong>unable</strong> to find any matches in the Matchmaker network for seqr ID " + seqrId;
	html += getGoBackMessageHtml();
	html += '</div>';
	$('#search-warning-messages').append(html);
}


/**
 * Add matched to UI
 */ 
function renderMatches(seqrId,matches){
	var numMatchesFound=0;
	if (matches['match_results']['local_results']['result']['results'].length > 0){
		setupRestultsTableHeaders();
		numMatchesFound += matches['match_results']['local_results']['result']['results'].length;
	}
	if(matches['match_results'].hasOwnProperty('external_results')){
		if (matches['match_results']['external_results']['result']['results'].length>0){
			setupRestultsTableHeaders();
			numMatchesFound += matches['match_results']['external_results']['result']['results'].length;
		}
	}
	if (numMatchesFound == 0)
	{	
		showNoMatchMessage(seqrId);
	}
	var persistedResults={};
	var resultId=0;
	for (var result_origin in matches['match_results']){
		//map of id to full patient obj
		if (200 == matches['match_results'][result_origin]['status_code']){
			for (var i=0; i<matches['match_results'][result_origin]['result']['results'].length; i++){
				var singlePatientResult;
				if (result_origin=="local_results"){
					singlePatientResult =  matches['match_results'][result_origin]['result']['results'][i];
				}
				if (result_origin=="external_results"){
					singlePatientResult =  matches['match_results'][result_origin]['result']['results'][i];
				}
			     	var patient=singlePatientResult['patient'];
			     	var score=singlePatientResult['score']['patient'];
			     	if (score == null){
			     		score="";
			     	}
			     	
			     	//persist patient in local session storage for showing full details in modal later	
					persistedResults[patient['id']]=patient;

		     		var html='<tr ';
		     		if (matches['result_analysis_state'][patient['id']]['seen_on'] == null){
		     			html += 'class="new_result">';
		     		}
		     		else{
		     			html += 'class="result_seen_before">';
		     		}

		     		
		     	
		     		//flag as target
		     		if (matches['result_analysis_state'][patient['id']]['flag_for_analysis'] == true){
		     			html += '<td><input class="flag_for_analysis" checked type="checkbox" id="'+ patient['id'] +'" value="' + seqrId +'"></td>';
		     		}
		     		else{
		     			html += '<td><input class="flag_for_analysis" type="checkbox" id="'+ patient['id'] +'" value="' + seqrId +'"></td>';
		     		}
		     		
		     		//field:deemed invalid
		     		if (matches['result_analysis_state'][patient['id']]['deemed_irrelevant'] == true){
		     			html += '<td><input class="deemed_irrelevant" checked type="checkbox" id="'+ patient['id'] +'" value="' + seqrId +'"></td>';
		     		}
		     		else{
		     			html += '<td><input class="deemed_irrelevant" type="checkbox" id="'+ patient['id'] +'" value="' + seqrId +'"></td>';
			     		
		     		}
		     		
		     		html += '<td>';
		     		html += seqrId;
		     		html += '</td>';
		     		
		     		//GenomicFeatures
		     		html += '<td>';
		     		if (patient.hasOwnProperty('genomicFeatures') &&  patient['genomicFeatures'].length>0){
			     		for (var k=0; k<patient['genomicFeatures'].length;k++){
			     			
			     			var geneId=patient['genomicFeatures'][k]['gene']['id'];
			     			if (geneId.search('ENSG')==0){
			     				//html += '<a onclick="showGeneInfoDisplay(' + "'"+ geneId +"'" +');">' + geneId + '</a>';
			     				var asyncGeneId='asyncGene_' + resultId.toString();
			     				html += '<div id="'+ asyncGeneId + '"></div>';
			     				addHgncToEnsembl(geneId, asyncGeneId);
			     			}
			     			else{
			     				html += geneId;
			     			}
			     			if (k<patient['genomicFeatures'].length-1){
			     				html += '<br>';
			     			}
			     		}
		     		}
		     		else{
		     			html += "";
		     		}
		     		html += '</td>';
		     		
		     		
		     		//Features (phenotypes)
		     		html += '<td>';
		     		if (patient.hasOwnProperty('features') && patient['features'].length>0){
			     		for (var p=0; p<patient['features'].length;p++){			     			
			     			var hpoTerm=patient['features'][p]['id'];
			     			var hpoName ='';
			     			if (matches['hpo_map'].hasOwnProperty(hpoTerm)){
			     				hpoName = matches['hpo_map'][hpoTerm]['name'];
			     			}
			     			html += hpoName + '&nbsp&nbsp('+ hpoTerm + ')';
			     			if (p<patient['features'].length-1){
			     				html += '<br>';
			     			}
			     		}
		     		}
		     		else{
		     			html += "";
		     		}
		     		html += '</td>';
		     		
		     		
		     		html += '<td>';
		     		html += score;
		     		html += '</td>';
		     		
		     		html += '<td>';
		     		html += '<a onclick="processDetailedDisplay(' + "'"+ patient['id'] +"'" +');">' + patient['id'] + '</a>';
		     		html += '</td>';
		     		html += '<td>';
		     		if (patient['contact'].hasOwnProperty('name')){
		     			html += patient['contact']['name'];
		     		}
		     		else{
			     		html += "";
		     		}
		     		html += '</td>';
		     		html += '<td>';
		     		html += patient['contact']['institution'];
		     		html += '</td>';
		     		html += '<td>';
		     		html += '<a href="' + patient['contact']['href'] + '">' + patient['contact']['href'] + '</a>';
		     		html += '</td>';
		     		
		     		
		     		//field:contacted host
		     		if (matches['result_analysis_state'][patient['id']]['we_contacted_host'] == true){
		     			html += '<td><input class="we_contacted_host" checked type="checkbox" id="'+ patient['id'] +'" value="' + seqrId +'"></td>';
		     		}
		     		else{
		     			html += '<td><input class="we_contacted_host" type="checkbox" id="'+ patient['id'] +'" value="' + seqrId +'"></td>';
		     		}
		     		
		     		//field:host contacted us
		     		if (matches['result_analysis_state'][patient['id']]['host_contacted_us'] == true){
		     			html += '<td><input class="host_contacted_us" checked type="checkbox" id="' + patient['id'] + '" value="' + seqrId +'"></td>';		     		
		     		}
		     		else{
		     			html += '<td><input class="host_contacted_us" type="checkbox" id="' + patient['id'] + '" value="' + seqrId +'"></td>';		     		
		     		}
		     		
		     		html += '<td>';
		     		html += '<textarea cols="4" rows="4" class="form-control match-comments" id="' + resultId.toString() +'">' + matches['result_analysis_state'][patient['id']]['comments']  + '</textarea>';		     		
		     		html += '<button type="button" class="btn btn-primary btn-sm save-comment-btn" onclick="matchCommentUpdate(' +"'" + patient['id'] + "'" + ",'" + seqrId + "'"  + ",'" + resultId.toString() + "'" + ');">save</button>';
		     		resultId +=1;

		     		html += '</td>'
		     		html += '</tr>';
		     		$('#mmeMatchResultTbl tbody').append(html);
			}
		}
	}
	//add to session storage
	sessionStorage.results=JSON.stringify(persistedResults);
	$('#mmeMatchResultTbl').DataTable();
	return numMatchesFound;
}

/**
 * Add this patient to the local matchmaker exchange node (matchbox) for sharing
 * Expects a JSON object that it stringifys
 **/
function searchInMME(patient,seqrId,project_id) {
	 $('#loading-in-progress-message').show();
	 var url = "/api/matchmaker/match_internally_and_externally/project/" + project_id + '/individual/' + seqrId;
	 var query = {'patient_data':JSON.stringify(patient)};
	 $.ajax({url: url, 
		 	type:'POST',
		 	data:query,
		 	dataType:'json',
		 	success: function(result){
		 		$('#loading-in-progress-message').hide();
		 		return renderMatches(seqrId,result);
		 	},
		 	error: function (jqXHR, textStatus, errorThrown)
		    {
		 		$('#loading-in-progress-message').hide();
				var html='<div class="alert alert-danger" role="alert"><p>Sorry, <strong>I was not able to reach</strong> the Broad matchmaker server to submit this family. Please try again in about 30mins or contact '; 
		 		html += '<strong><a href="mailto:matchmaker@broadinstitute.org">matchmaker@broad</a></strong> for immediate help.';
		 		$('#search-warning-messages').append(html);
		 		console.log(errorThrown);
		 		console.log(jqXHR);
		    },
		    async:true,  
	 });
}
</script>


<script>
/**
 * Shows a detailed patient structure in a modal
 */
function addPatientToModal(patient){
	console.log(patient);
	var html='<table id="detailedResultTbl" class="table table-hover">';
	html += '<thead><tr>';
	html += '<td><p>' + 'Field' + '</p></td>';
	html += '<td><p>' + 'Value' + '</p></td>';
	html += '</tr></thead><tbody>';

	//General	
	html += '<tr><td><p>Id</p></td>' + '<td><p>' +patient['id'] + '</p></td></tr>';
	if (patient.hasOwnProperty('sex')){
		html += '<tr><td><p>sex' + '<td><p>' +patient['sex'] + '</p></td></tr>';
	}
	if (patient.hasOwnProperty('label')){
		html += '<tr><td><p>label</p></td>' + '<td><p>' +patient['label'] + '</p></td></tr>';
	}
	if (patient.hasOwnProperty('species')){
		html += '<tr><td><p>species</p></td>' + '<td><p>' +patient['species'] + '</p></td></tr>';
	}
	if (patient['contact'].hasOwnProperty('name')){
		html += '<tr><td><p>Contact name</p></td>' + '<td><p>' +patient['contact']['name'] + '</p></td></tr>';
	}
	if (patient['contact'].hasOwnProperty('href')){
		html += '<tr><td><p>Contact URL</p></td>' + '<td><p>' +patient['contact']['href'] + '</p></td></tr>';
	}
	if (patient['contact'].hasOwnProperty('institution')){
		html += '<tr><td><p>Contact institution</p></td>' + '<td><p>' +patient['contact']['institution'] + '</p></td></tr>';
	}
	
	//Phenotypes
	if (patient.hasOwnProperty('features') && patient['features'].length>0){
		html += '<tr><td><p>Phenotypes</p></td><td><table class="table table-hover"><thead><td></td><td></td></thead><tbody>'; 
		for (var j=0; j<patient['features'].length;j++){
			html += '<tr><td>' + patient['features'][j]['id'] + '</td><td>' + patient['features'][j]['observed'] + '<p><tr>';
		}
		html += '</tbody></table></td></tr>';
	}
	//Genotypes sub table
	if (patient.hasOwnProperty('genomicFeatures') && patient['genomicFeatures'].length>0){
		html += '<tr>';
		html += '<td><p>Genotypes</p></td><td>';
		html += '<table class="table table-hover">';
		html += '<thead><tr>';
		html += '<td>Gene Id</td>';
		html += '<td>Reference name</td>';
		html += '<td>Assembly</td>';
		html += '<td>Variant-start</td>';
		html += '<td>Variant-end</td>';
		html += '<td>Reference bases</td>';
		html += '<td>Alternate bases</td>';
		html += '</tr></thead><tbody>'
		for (var k=0; k<patient['genomicFeatures'].length;k++){

				html += '<tr>';
				html += '<td><p>'  +  patient['genomicFeatures'][k]['gene']['id']   + '</p></td>';
				html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['referenceName']   + '</p></td>';
				html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['assembly']   + '</p></td>';
				html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['start']   + '</p></td>';
				html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['end']   + '</p></td>';
				html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['referenceBases']   + '</p></td>';
				html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['alternateBases']   + '</p></td>';
				html += '</tr>';
		}
		//close sub table
		html += '</tbody></table></td></tr>';	
	}
	//close main table
	html += '</tbody></table>'
	$('#detailedResultTbl').remove();
	$('#detailedResultContainer').append(html);
	return 0;
}
</script>

<script>

/**
 * Sets up the column headers for the table that shows search results
 */
function setupRestultsTableHeaders(){
	$('#mmeResultsContainer').empty();
	var html = '<h4 class="section-header">Match results</h4>';
    html += '<table id="mmeMatchResultTbl" class="table table-hover">';
    html += '<thead><tr>';
    html += '<td><p>Flag for analysis</p></td>';
    html += '<td><p>Will not pursue</p></td>';
	html += '<td><p>seqr Id</p></td>';
	html += '<td><p>Gene Ids</p></td>';
	html += '<td><p>Phenotypes</p></td>';
	html += '<td><p>Score</p></td>';
	html += '<td><p>Match Id</p></td>';  		
	html += '<td><p>Contact name</p></td>';		
	html += '<td><p>Contact institution</p></td>';
	html += '<td><p>Contact URI</p></td>';
	html += '<td><p>Contacted host</p></td>';
	html += '<td><p>Host contacted us</p></td>';
	html += '<td><p>Comments</p></td>';
	//TODO: needs more work: html += '<td><p>Last update by</p></td>';
	html += '</tr>';
	html += '</thead>';
	html += '<tbody></tbody>';
	html += '</table>';
	$('#mmeResultsContainer').append(html);
}

/**
 * Sets up the column headers for the table that shows the last submission to MME
 */
function setupLastSubmissionTableHeaders(){
	$('#mmeLastSubmissionContainer').empty();
	var html = '<h4 class="section-header">These most recent submissions are <strong>shared</strong> within the Matchmaker Exchange, ';
	html += 'and used for matching &nbsp&nbsp<button type="button" class="btn btn-primary" onclick="startORUpdateASubmitionToMME();">update submission</button></h4>';
	html += '<table id="mmeLastSubmissionTbl" class="table table-hover">';
	html += '<thead><tr>';
	html += '<td><p><i>seqr</i> ID</p></td>';
    html += '<td><p>Genotypes</p></td>';		
	html += '<td><p>Phenotypes</p></td>';	
	html += '</tr></thead>';
	html += '<tbody></tbody>';
	html += '</table>';
	$('#mmeLastSubmissionContainer').append(html);
}
</script>



<script>
/**
 * Returns a mesaage
 */
function getGoBackMessageHtml(){
	var famHref="/project/" + sessionStorage.projectId + "/family/"+ sessionStorage.familyId;
	var html = '<p>You can return to <strong><a href="'+famHref+'">family</a></strong> page, or try to add more genotype and phenotype data and try the individual once more.</p>';
	return html;
}


function showLimitMsg(){
	console.log('boo');
}

$('body').on('click', 'input.host_contacted_us', 
		function(i) {
			var matchId = $(this)[0]['id'];
			var indiv_id = $(this)[0]['value'];
			if( !$(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"host_contacted_us","state":"false"},matchId,sessionStorage.projectId,indiv_id);
			}
			if( $(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"host_contacted_us","state":"true"},matchId,sessionStorage.projectId,indiv_id);
			}
		});
		
$('body').on('click', 'input.we_contacted_host', 
		function(i) {
			var matchId = $(this)[0]['id'];
			var indiv_id = $(this)[0]['value'];
			if( !$(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"we_contacted_host","state":"false"},matchId,sessionStorage.projectId,indiv_id);
			}
			if( $(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"we_contacted_host","state":"true"},matchId,sessionStorage.projectId,indiv_id);
			}
		});

$('body').on('click', 'input.deemed_irrelevant', 
		function(i) {
			var matchId = $(this)[0]['id'];
			var indiv_id = $(this)[0]['value'];
			if( !$(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"deemed_irrelevant","state":"false"},matchId,sessionStorage.projectId,indiv_id);
			}
			if( $(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"deemed_irrelevant","state":"true"},matchId,sessionStorage.projectId,indiv_id);
			}
		});
		
$('body').on('click', 'input.flag_for_analysis', 
		function(i) {
			var matchId = $(this)[0]['id'];
			var indiv_id = $(this)[0]['value'];
			if( !$(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"flag_for_analysis","state":"false"},matchId,sessionStorage.projectId,indiv_id);
			}
			if( $(this).is(':checked') ) {
				updateMatchResultStateEvent({"state_type":"flag_for_analysis","state":"true"},matchId,sessionStorage.projectId,indiv_id);
			}
		});
		
		

/**
 * Listens and updates which genotypes that should be submitted
 */
$('body').on('click', 'input.selected_genomic_features', 
	function(i) {
		var genotypes_to_submit = JSON.parse(sessionStorage.genotypes_to_submit);
		var valFields = $(this).val().split(',');
		var genotypeId=valFields[0];
		if( $(this).is(':checked') ) {
			genotypes_to_submit.push({
								"genotypeId" : valFields[0],
								"ensemblGeneId":valFields[1],
								"hgncId":valFields[2],
								"referenceName":valFields[4],
								"assembly":valFields[3],
								"variantStart":parseInt(valFields[5]),
								"variantEnd":parseInt(valFields[6]),
								"referenceBases":valFields[7],
								"alternateBases":valFields[8],
								"zygosity":parseInt(valFields[9]),
								"seqrTagName":valFields[10],
								"seqrIndivSampleInd":valFields[11]
								});
		}
		if( !$(this).is(':checked') ) {
			var temp = [];
			for (var i in genotypes_to_submit){
				if (genotypes_to_submit[i]['genotypeId'] != genotypeId ){
					temp.push(genotypes_to_submit[i]['genotypeId']);	
				}
			}
			genotypes_to_submit = temp;	
		}
		sessionStorage.genotypes_to_submit = JSON.stringify(genotypes_to_submit);
}); 


/**
 * Listens and updates which phenotypes that should be submitted
 */
$('body').on('click', 'input.selected_phenotype_features', 
	function(i) {
		var phenotypes_to_submit = JSON.parse(sessionStorage.phenotypes_to_submit);
		var valFields = $(this).val().split(',');
		var hpoTerm = valFields[0];
		
		if( $(this).is(':checked') ) {
			phenotypes_to_submit.push({
				"hpoTerm" : valFields[0],
				"hpoDescription":valFields[1],
				"observed":valFields[2]
			});
		}
		if( !$(this).is(':checked') ) {
			var temp = [];
			for (var i in phenotypes_to_submit){
				if (phenotypes_to_submit[i]['hpoTerm'] != hpoTerm ){
					temp.push(phenotypes_to_submit[i]);
				}
			}
			phenotypes_to_submit = temp;	
		}
		sessionStorage.phenotypes_to_submit = JSON.stringify(phenotypes_to_submit);
});



/**
 * Listens and updates when MME reciept contact name change requests happen
 */
function addAdditionalContactName(){
	var existingContactNames = $('#contact-name').text().split(',');
	var localContact = existingContactNames[0];
	var otherNames='';
	for (var i=1; i<existingContactNames.length;i++){
		otherNames += existingContactNames[i];
		if (i<existingContactNames.length){
			otherNames += ',';
		}
	}
	var html='<div id="add-new-contact-name-container">';
	html += '&nbsp&nbsp<textarea id="add-new-contact-name-textarea" rows="1" cols="50">' + $.trim(otherNames)  + '</textarea>';
	html += '&nbsp&nbsp<button type="button" class="btn btn-primary" onclick="updateWithNewContactName(' + "'add-new-contact-name-textarea'," + "'add-new-contact-name-container'," + "'contact-name','" + localContact +"'"+ ');" id="save-new-contact-btn">save</button>';
	html += '</div>'; 
	$('#contact-name-container').append(html);
}

/**
 * Listens and updates the MME submission with regards to how much variant data to share
 */
function limitSharingOfVariantData(divId,singlePatientGenotypeInfoId){
	var lockedIcon='<a href="javascript:limitSharingOfVariantData('+"'"+divId+ "'" +');">&nbsp&nbsp<i class="fas fa-lock fa-lg" aria-hidden="true"></i></a>';
	var unlockedIcon='<a href="javascript:limitSharingOfVariantData('+"'"+divId+ "'" +');">&nbsp&nbsp<i class="fas fa-lock-open fa-lg" aria-hidden="true"></i></a>';
	var limit_sharing_of_variant_level_data = JSON.parse(sessionStorage.limit_sharing_of_variant_level_data);

	if ($('#'+divId).hasClass('open')){
		$('#'+divId).empty();
		$('#'+divId).append(lockedIcon);	
		$('#'+divId).removeClass('open').addClass('closed');
		limit_sharing_of_variant_level_data[singlePatientGenotypeInfoId]='restrict';
	}
	else{
		$('#'+divId).empty();
		$('#'+divId).append(unlockedIcon);
		$('#'+divId).removeClass('closed').addClass('open');
		limit_sharing_of_variant_level_data[singlePatientGenotypeInfoId]='share';
	}
	
	//serialize back
	sessionStorage.limit_sharing_of_variant_level_data = JSON.stringify(limit_sharing_of_variant_level_data);
	return;
}

/**
 * Add new contact to contact name data structure. This gets triggered when user hits "save" button on dynamic text field
 */
function updateWithNewContactName(divName,dynamicTextContainerName,updateTarget,localContactName){
	var newContacts = $('#'+divName).val();
	var newContactsField = localContactName;
	if (newContacts.length != 0){
		var newContactsField = newContactsField + "," + newContacts;
	}
	$('#'+updateTarget).text(newContactsField.replace(/,\s*$/, ""));
	$('#'+dynamicTextContainerName).remove();
	//update submission data structure
	var patientSubmission = JSON.parse(sessionStorage.structToBeSubmitted);
	patientSubmission['contact']['name'] = newContactsField.replace(/,\s*$/, "");
	sessionStorage.structToBeSubmitted = JSON.stringify(patientSubmission);
}

/**
 * Listens and updates when MME reciept contact email change requests happen
 */
function addAdditionalContactEmail(){
	var existingUrls = $('#contact-url').text().split(',');
	var localMatchmakerUrl = existingUrls[0];
	var otherUrls='';
	for (var i=1; i<existingUrls.length;i++){
		otherUrls += existingUrls[i];
		if (i<existingUrls.length){
			otherUrls += ',';
		}
	}
	var html= '<div id="add-new-email-container">';
	html +='&nbsp&nbsp<textarea id="add-new-email-textarea" rows="1" cols="50" placeholder="add another email address">'+ otherUrls +'</textarea>';
	html += '&nbsp&nbsp<button type="button" class="btn btn-primary" onclick="updateWithNewEmail(' + "'add-new-email-textarea'"   +"," + "'add-new-email-container'" + ","  + "'contact-url'"  + ",'" +  localMatchmakerUrl  + "'"+');">save</button>';
	html += '</div>';
	$('#contact-url-container').append(html);
}

/**
 * Add new email to data structure. This gets triggered when user hits "save" button on dynamic text field
 */
function updateWithNewEmail(divName,containerName,updateTarget,localContactEmailAddr){
	var newEmailsAdded = $('#'+divName).val();
	var newEmailField = localContactEmailAddr;
	if (newEmailsAdded.length != 0){
		var newEmailField = newEmailField + "," + newEmailsAdded;
	}
	$('#'+updateTarget).text(newEmailField.replace(/,\s*$/, ""));
	$('#'+containerName).remove();
	//update submission data structure
	var patientSubmission = JSON.parse(sessionStorage.structToBeSubmitted);
	patientSubmission['contact']['href'] = newEmailField.replace(/,\s*$/, "");
	sessionStorage.structToBeSubmitted = JSON.stringify(patientSubmission);
}



/**
 * When the user is ready to submit the individual and hits submit button after looking
 * at the reciept
 */
$('#submitIndividualBtn').click(
		function submit(){
			var localId = JSON.parse(sessionStorage.seqrIdOfSubmissionCandidate);
			var structToBeSubmitted = JSON.parse(sessionStorage.structToBeSubmitted);
			if (structToBeSubmitted['genomicFeatures'].length>0 || structToBeSubmitted['features'].length>0 ){
				console.log(structToBeSubmitted);
				addToMME(structToBeSubmitted,localId);
			}
			else{
				var backHref="/project/" + sessionStorage.projectId + "/family/"+ sessionStorage.familyId;
				var html='<div class="alert alert-danger" role="alert"><p>Sorry, <strong>you have no genotype or phenotype data to submit.</strong> You need one of those data to be entered for a submission to be possible.'; 
			 	html += ' Please tag variants or enter phenotype data or contact <strong><a href="mailto:matchmaker@broadinstitute.org">matchmaker@broad</a></strong> for immediate help. Please click <a href="';
			 	html += backHref + '">';
			 	html += 'here</a> to go back.';
			 	$('#no-data-warning-messages').append(html);
			}
});
		
	

/**
 * Add this patient to the local matchmaker exchange node (matchbox) for sharing
 * Expects a JSON object that it stringifys
 **/
function addToMME(patient,localId) {
	 var url = "/api/matchmaker/add";
	 var query = {'patient_data':JSON.stringify(patient), 
			 	  'projectId':sessionStorage.projectId,
			 	  'familyId':sessionStorage.familyId,
			 	  'localId':localId};
	 console.log(patient);
	 $.ajax({url: url, 
		 	type:'POST',
		 	data:query,
		 	dataType:'json',
		 	success: function(result){
		 		console.log(result);
		 		if (result['status_code'] == 200) {
		 			html ='<p><h2><strong>Successfully</strong> submitted individual '+ localId + '.</h2></p>';
		 			html += result['http_result']['message'];
		 			html += ' ' + getGoBackMessageHtml();
		 			$('#submissionStateMessageModalHeader').css({'background-color':'#66ff33','color':'black'});
		 		}
		 		else{
		 			var submittedBeforeMesg = result['http_result']['message'].search("already exists");
		 			if (submittedBeforeMesg > 0){
		 				html ='<p><h2><strong>Successfully</strong> submitted individual '+ localId + '.</h2></p>';
		 				$('#submissionStateMessageModalHeader').css({'background-color':'#ffff00','color':'black'});
		 			}
		 			else{
		 				html ='<p><h2><strong>Sorry, there was an error with the submission of</strong>&nbsp' + localId  + '.</h2></p>';
		 				$('#submissionStateMessageModalHeader').css({'background-color':'red','color':'white'});
		 			}
		 			html += '<p><h4><strong>Please note:</strong></h4></p>';
		 			html += '<h4>' + result['http_result']['message'] + '</h4>';
		 			html += ' ' + getGoBackMessageHtml();
		 		}
		 		html +='</p></div>';
		 		
		 		$('#submissionStateMessageModalModalBody').empty();
		 		$('#submissionStateMessageModalModalBody').append(html);
		 		$('#submissionStateMessageModal').modal('show'); 
		 	},
		 	error: function (jqXHR, textStatus, errorThrown)
		    {	
		 		console.log(jqXHR);
				var html='<div><p>Sorry, <strong>I was not able to reach</strong> the Broad matchmaker server to submit this family. Please try again in about 30mins or contact '; 
		 		html += '<strong><a href="mailto:matchmaker@broadinstitute.org">matchmaker@broad</a></strong> for immediate help.</p></div>';
		 		
		 		$('#submissionStateMessageModalHeader').css({'background-color':'red',
		 													 'color':'white'
		 													});
		 		$('#submissionStateMessageModalModalBody').empty();
		 		$('#submissionStateMessageModalModalBody').append(html);
		 		$('#submissionStateMessageModal').modal('show'); 

		    },
		    async:true,  
	 });
}

		

		
/**
** Updates a comment made on a match result
**/
function matchCommentUpdate(id,indiv_id,resultId) {
	//text area ID is the patient ID of that row
	var val = $('textarea#' + resultId).val();
    $.ajax({url: '/api/matchmaker/result_tracking/comments/project/' + sessionStorage.projectId +'/match_id/' + id + '/individual/' + indiv_id,
	 	type:'POST',
	 	data:{"comment": val},
	 	dataType:'json',
	 	success: function(result){
	 		console.log(result);
	 	},
	 	error: function (jqXHR, textStatus, errorThrown)
	    {	
	 		console.log(jqXHR);
	 		$('#messageModalHeader').css({'background-color':'red',
				  'color':'white'
			});
			$('#stateUpdateErrorModal').modal('show');
	    },
	    async:false,  
 });
       return true;
}
		
		
/**
 * Updates a state change event via AJAX
 */
function updateMatchResultStateEvent(newMatchResultState,matchId,projectId, indiv_id){
	var encodedUrl='/api/matchmaker/result_tracking/match_state_update/project/' + projectId +'/match_id/' + encodeURIComponent(matchId) + '/individual/' + indiv_id;
    console.log(encodedUrl);
	$.ajax({url: encodedUrl,
	 	type:'POST',
	 	data:newMatchResultState,
	 	dataType:'json',
	 	success: function(result){
	 		console.log(result);
	 	},
	 	error: function (jqXHR, textStatus, errorThrown)
	    {	
	 		console.log(jqXHR);
	 		console.log(jqXHR);
	 		$('#messageModalHeader').css({'background-color':'red',
				  'color':'white'
			});
			$('#stateUpdateErrorModal').modal('show');
	    },
	    async:false,  
 });	
	
}


/**
 * Updates or makes a submission
 * -------------------------------------------------------------
*/


/**
 * Start the export process
 */
function startORUpdateASubmitionToMME(){
	sessionStorage.genotypes_to_submit  = JSON.stringify([]); //list of genotypes to submit to MME
	sessionStorage.limit_sharing_of_variant_level_data = JSON.stringify({}); //don't share variant info with matches
	sessionStorage.phenotypes_to_submit = JSON.stringify([]); //list of phenotypes to submit to MME
	sessionStorage.patient = {}; 							  //patient data back from server

	var url='/api/reports/project/' + sessionStorage.projectId + '/family/' + sessionStorage.familyId + '/individuals/';
	$.ajax({
		url: url, 
	 	type:'GET',
	 	success: function(result){
	 		var html='<div class="form-group"><select onchange="startExportProcess(this);" class="form-control" id="indivToSubmit">';
	 		html += '<option id="prompt"><label>Please select the affected individual that you wish to share on the Matchmaker Exchange</label></option>';
	 		for(var i in result.individuals){
	 			if (result.individuals[i]['affected']=='A'){
	 				html += '<option id="'+ result.individuals[i]['indiv_id'] + '">' +  result.individuals[i]['indiv_id']+ '</option>';
	 			}
	 		}
	 		html += '</select></div>';
	 		$('#individualsToSubmit').append(html);
	 	},
	 	error: function (jqXHR, textStatus, errorThrown)
	    {
	 		console.log(errorThrown);
	 		console.log(jqXHR);
	    },
	    async:true,  
 	});
	$('#updateSubmissionModal').modal('show');
}

 /**
  * Given a patient ID (NAxxx,) export all data about it to matchmaker exchange for sharing
  **/
 function startExportProcess(el) {
	 if (el.options[el.selectedIndex].id != 'prompt'){
	     var indivId = el.options[el.selectedIndex].value;
	     sessionStorage.seqrIdOfSubmissionCandidate = JSON.stringify(indivId);
	 	 var url = "/api/matchmaker/candidate/project/" + sessionStorage.projectId +"/family/" + sessionStorage.familyId  + "/individual/" + indivId;
	 	 $.ajax({url: url, 
	 		 	success: function(result){
	 		 	   $('#genotypeSubmissionCandidateInfo').empty();
	 		 	   $('#phenotypeSubmissionCandidateInfo').empty();
	 		 	   $('#dataToBeSubmittedReceipt').empty();
	 		 	   $('#dataToBeSubmittedReceiptContainer').hide();
	 	           showMMECandidates(result);
	 		 	},
	 		    async:false,  
	 	 });
	 }
	 return true;
 }

 /**
  * Show submission candidates and get approval
 */
function showMMECandidates(result){
 	var html='';

 	var patient=result['submission_candidate'];
 	sessionStorage.patient = JSON.stringify(patient);
 	var idMap = result['id_map'];
 	
 	limit_sharing_of_variant_level_data = JSON.parse(sessionStorage.limit_sharing_of_variant_level_data);
 	
 	//-------------------------------------------Phenotype info
 	if (patient['features'].length>0){
	 	html += '<table id="showMMECandidatesPhenotypeTable" class="table table-hover">';
	 	html += '<thead><tr><th>Id</th><th>Description</th><th>Observed</th><th>Submit</th></tr></thead>';
	 	html += '<tbody>';
	 	for (var j=0; j<patient['features'].length;j++){
	 		if (!isValidHpoTerm(patient['features'][j]['id'])){
	 			console.log("ERROR: invalid HPO term detected and not submitting to MME:" +patient['features'][j]['id']);
	 		}
	 		else{
				html += '<tr>';
		 		html += '<td><p>' + patient['features'][j]['id'] + '</p></td>';
		 		var singlePhenotypeInfo = patient['features'][j]['id'];
		 			
		 		html += '<td><p>' + patient['features'][j]['label'] +  '</p></td>';
		 		singlePhenotypeInfo += ',' + patient['features'][j]['label'];
				
		 		if (patient['features'][j]['observed']=='yes'){
		 			html += '<td><p class="phenotype-observed-yes">' + patient['features'][j]['observed'] +  '</p></td>';
		 		}
		 		else{
		 			html += '<td><p class="phenotype-observed-no">' + patient['features'][j]['observed'] +  '</p></td>';
		 		}
		 		singlePhenotypeInfo += ',' + patient['features'][j]['observed'];
		 		
		 		html += '<td><p>'  +  '<input class="selected_phenotype_features" type="checkbox" id="'+ idMap['individual_id'] + '" value="'+ singlePhenotypeInfo +'"></p></td>';
		 		html += '</tr>';
	 		}
	 		}
	 	html += '</tbody></table>';
	 	$('#phenotypeSubmissionCandidateInfo').empty();
	 	$('#phenotypeSubmissionCandidateInfo').append(html);
	 	$('#showMMECandidatesPhenotypeTable').DataTable();
 	}
 	
 	//-------------------------------------------now add Genotypes (if any)
 	if (patient['genomicFeatures'].length>0){
	 	//sub table inside cell for list of variants
	 	html = '<table id="genotypeSubmissionCandidateInfoTbl" class="table table-hover">';
	 	html += '<tr>';
	 	html += '<th>Gene Id</th>';
	 	html += '<th>Gene symbol</th>';
	 	html += '<th>Assembly</th>';
	 	html += '<th>Variant</th>';
	 	html += '<th></th>';
	 	html += '<th>Zygosity</th>';
	 	html += '<th><i>seqr</i> Tag name</th>';
	 	html += '<th>Submit</th>';	
	 	html += '</tr>';
	 	html += '<tbody>';
	 	
	 	//now each row is an affected patient
	 	for (var k=0; k<patient['genomicFeatures'].length;k++){
	 		//skipping genes with no ID which is a seqr artifact, and MME kicks these back
	 		if (patient['genomicFeatures'][k]['gene']['id'] != ""){	
	
		 		html += '<tr>';
				
		 		//using k as a genotype ID of sorts for later comparison
		 		var singlePatientGenotypeInfoId = k.toString();
		 		var singlePatientGenotypeInfo = singlePatientGenotypeInfoId;
		 		
		 		html += '<td><p>'  +  patient['genomicFeatures'][k]['gene']['id']   + '</p></td>';
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['gene']['id'];
		 		
		 		html += '<td><p>'  +  patient['genomicFeatures'][k]['auxiliary']['gene_symbol']   + '</p></td>';
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['auxiliary']['gene_symbol'];
		 		
		 		html += '<td><p>'  +  patient['genomicFeatures'][k]['variant']['assembly']   + '</p></td>';
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['variant']['assembly'];
		 		
		 		////variant field
		 		html += '<td class="submissionCandidateTable-variant-column"><p>';
		 		html += 'chr' + patient['genomicFeatures'][k]['variant']['referenceName'] + ":";
		 		html += patient['genomicFeatures'][k]['variant']['start'];
		 		html += '&nbsp' + patient['genomicFeatures'][k]['variant']['referenceBases'];
		 		html += '&nbsp>&nbsp';
		 		html += patient['genomicFeatures'][k]['variant']['alternateBases'];
		 		html += '</p></td>';
		 		
		 		var limitSharingDivId='limit-variant-sharing-' + k.toString();
		 		limit_sharing_of_variant_level_data[k.toString()]='share';
		 		html += '<td id="' + limitSharingDivId + '" class="open"><a href="javascript:limitSharingOfVariantData('+"'"+limitSharingDivId+ "'" + ",'"+singlePatientGenotypeInfoId+ "'" +');">&nbsp&nbsp<i class="fas fa-lock-open fa-lg" aria-hidden="true"></i></a></td>';
		 		
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['variant']['referenceName'];
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['variant']['start'] ;
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['variant']['end'];
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['variant']['referenceBases'];
		 		singlePatientGenotypeInfo += ',' + patient['genomicFeatures'][k]['variant']['alternateBases'];
		 		
		 		html += '<td><p>'  +  patient['genomicFeatures'][k]['zygosity'].toString()   + '</p></td>';
		 		singlePatientGenotypeInfo += ','+ patient['genomicFeatures'][k]['zygosity'].toString();
		 		
		 		html += '<td><p>'  +  patient['genomicFeatures'][k]['auxiliary']['tag_name']   + '</p></td>';
		 		singlePatientGenotypeInfo += ','+ patient['genomicFeatures'][k]['auxiliary']['tag_name'];
		 		
		 		singlePatientGenotypeInfo += ','+ idMap['individual_id'];
		 		
		 		html += '<td><p>'  +  '<input class="selected_genomic_features" type="checkbox" id="'+ idMap['individual_id'] + '" value="'+ singlePatientGenotypeInfo +'"></p></td>';
		 		html += '</tr>';
	 		}
	 	}
	 	
	 	//close sub table
	 	html += '</tbody></table>';
	 		
	 	$('#genotypeSubmissionCandidateInfo').empty();
	 	$('#genotypeSubmissionCandidateInfo').append(html);
 	}
 	$('#submissionCandidatesContainer').show();
 	
 	//serialize back
 	sessionStorage.limit_sharing_of_variant_level_data = JSON.stringify(limit_sharing_of_variant_level_data);
 }

 /**
  * Some HPO terms returned from PhenoTips were invalid, till the
  * root issue (PhenoTips) is fixed, this is put in place
  * Rules:
 	 1. HPO terms are 7 digits long
  */
function isValidHpoTerm(term){
 	if (term.split(":")[1].length == 7){
 		return true;
 	}
 	return false;
 }
 



/**
 * Shows the final patient structure that is about to be submitted
 */
function showDataToBeSubmitted(){
	var patient = JSON.parse(sessionStorage.patient);
	var genotypes_to_submit = JSON.parse(sessionStorage.genotypes_to_submit);
	var variants_to_limit_sharing = JSON.parse(sessionStorage.limit_sharing_of_variant_level_data);
	var phenotypes_to_submit = {};
	var temp=JSON.parse(sessionStorage.phenotypes_to_submit);
	for (var i in temp){
		phenotypes_to_submit[temp[i]['hpoTerm']]=temp[i];
	}
	var structToBeSubmitted={};

	var html='<div>';
	html += '<br><label>We are <strong>about to submit the following information</strong> to the Matchmaker Exchange. These would be searchable within the network.'
	html += '<table id="finalSelectionTbl" class="table table-hover">';
	html += '<thead><tr>';
	html += '<td><p>' + 'Field' + '</p></td>';
	html += '<td><p>' + 'Value' + '</p></td>';
	html += '</tr></thead><tbody>';	
		
	//General
	html += '<tr><td><p>Id</p></td>' + '<td><p>' +patient['id'] + '</p></td></tr>';
	html += '<tr><td><p>sex' + '<td><p>' +patient['sex'] + '</p></td></tr>';
	html += '<tr><td><p>label</p></td>' + '<td><p>' +patient['label'] + '</p></td></tr>';
	html += '<tr><td><p>species</p></td>' + '<td><p>' +patient['species'] + '</p></td></tr>';
	
	html += '<tr><td id="additional_contact_name"><p>Contact name</p></td>' + '<td id="contact-name-container"><span id="contact-name">' +patient['contact']['name'] + '</span>&nbsp&nbsp&nbsp&nbsp';
    html += '<a href="javascript:addAdditionalContactName();"><i class="fa fa-edit" aria-hidden="true"></i></a>';
    html += '</td></tr>';
	
	html += '<tr><td id="additional_contact_email"><p>Contact URL</p></td>' + '<td id="contact-url-container"><span id="contact-url">' +patient['contact']['href'] + '</span>&nbsp&nbsp&nbsp&nbsp';
	html += '<a href="javascript:addAdditionalContactEmail();"><i class="fa fa-edit" aria-hidden="true"></i></a>';
	html += '</td></tr>';
	
	html += '<tr><td><p>Contact institution</p></td>' + '<td><p>' +patient['contact']['institution'] + '</p></td></tr>';
	
	//-----------let's also put this info into a structure we can use to submit to MME (general)
	structToBeSubmitted['contact']=patient['contact'];
	structToBeSubmitted['id']=patient['id'];
	structToBeSubmitted['label']=patient['label'];
	structToBeSubmitted['species']=patient['species'];
	
	//Phenotypes
	//-----------let's also put this info into a structure we can use to submit to MME (phenotypes)
	structToBeSubmitted['features']=[];
	html += '<tr><td><p>Phenotypes</p></td><td><table class="table table-hover"><thead><td></td><td></td><td></td></thead><tbody>'; 
	for (var j in phenotypes_to_submit){
			console.log(phenotypes_to_submit);
			html += '<tr><td>' + j + '</td><td>' + phenotypes_to_submit[j]['hpoDescription'] + '</td><td>'+ phenotypes_to_submit[j]['observed']  +'</td><tr>';
			structToBeSubmitted['features'].push({
													"observed":phenotypes_to_submit[j]['observed'],
													"label":phenotypes_to_submit[j]['hpoDescription'],
													"id":j
												});
	}
	html += '</tbody></table></td></tr>';
		
	//Genotypes sub table
	html += '<tr>';
	html += '<td><p>Genotypes</p></td><td>';
	html += '<table class="table table-hover">';
	html += '<thead><tr>';
	html += '<td>Gene Id</td>';
	html += '<td>Reference name</td>';
	html += '<td>Assembly</td>';
	html += '<td>Variant-start</td>';
	html += '<td>Variant-end</td>';
	html += '<td>Reference bases</td>';
	html += '<td>Alternate bases</td>';
	html += '<td>Zygosity</td>';
	html += '<td></td>';
	html += '</tr></thead><tbody>'
	//-----------let's also put this info into a structure we can use to submit to MME (genotypes)
	structToBeSubmitted['genomicFeatures']=[];
	for (var k=0; k<genotypes_to_submit.length;k++){
			html += '<tr>';
			html += '<td><p>'  +  genotypes_to_submit[k]['ensemblGeneId'] + '(' + genotypes_to_submit[k]['hgncId']  +  ')'  + '</p></td>';
			html += '<td><p>'  +  genotypes_to_submit[k]['referenceName']   + '</p></td>';
			html += '<td><p>'  +  genotypes_to_submit[k]['assembly']   + '</p></td>';
			html += '<td><p>'  +  genotypes_to_submit[k]['variantStart']   + '</p></td>';
			html += '<td><p>'  +  genotypes_to_submit[k]['variantEnd']   + '</p></td>';
			html += '<td><p>'  +  genotypes_to_submit[k]['referenceBases']   + '</p></td>';
			html += '<td><p>'  +  genotypes_to_submit[k]['alternateBases']   + '</p></td>';
			html += '<td><p>'  +  genotypes_to_submit[k]['zygosity']   + '</p></td>';
			
			var sharePreference=true;
			if (variants_to_limit_sharing[genotypes_to_submit[k]['genotypeId']] != 'share'){
				sharePreference=false;
			}
			var lockedIcon='&nbsp&nbsp<i class="fas fa-lock fa-lg" aria-hidden="true"></i>';
			var unlockedIcon='&nbsp&nbsp<i class="fas fa-lock-open fa-lg" aria-hidden="true"></i>';
			if ('share' == variants_to_limit_sharing[genotypes_to_submit[k]['genotypeId']]){
				html += '<td class="limit-variant-sharing">' + unlockedIcon + '</td>';
			}
			else{
				html += '<td class="limit-variant-sharing">' + lockedIcon + '</td>';
			}
			html += '</tr>';
			
			structToBeSubmitted['genomicFeatures'].push({
														"gene":{
															"id":genotypes_to_submit[k]['ensemblGeneId']
														},
														"variant":{
															"alternateBases":genotypes_to_submit[k]['alternateBases'],
															"assembly":genotypes_to_submit[k]['assembly'],
															"end":genotypes_to_submit[k]['variantEnd'],
															"referenceBases":genotypes_to_submit[k]['referenceBases'],
															"referenceName":genotypes_to_submit[k]['referenceName'],
															"start":genotypes_to_submit[k]['variantStart'],
															'_share':sharePreference
														},
														"zygosity":genotypes_to_submit[k]['zygosity'] 
														});
	}
	//close sub table
	html += '</tbody></table></td></tr>';		
	//close main table
	html += '</tbody></table>';
	html += '</div><br>';
	
	//store this for later use in submission event
	sessionStorage.structToBeSubmitted = JSON.stringify(structToBeSubmitted);
	
	//var limit_sharing_of_variant_level_data = JSON.parse(sessionStorage.limit_sharing_of_variant_level_data);
	console.log(limit_sharing_of_variant_level_data);

	$('#dataToBeSubmittedReceipt').empty();
	$('#dataToBeSubmittedReceipt').append(html);
	$('#dataToBeSubmittedReceiptContainer').show();
}


/**
 * Given a Enseml ID and a div, will make up some text string that
 * looks like HGNCID(EnsemblID)
 * to add to the given div, after a call to a service API
 */
function addHgncToEnsembl(ensemblId, divToUse){
	var url="/api/gene-info/" + ensemblId;
	 $.ajax({url: url, 
		 	dataType:'json',
		 	success: function(result){
				var hgncId=result['gene']['symbol'];
		 		$('#' + divToUse).append(hgncId + ' (<a onclick="showGeneInfoDisplay(' + "'"+ ensemblId +"'" +');">' + ensemblId + '</a>)<br>') ;
		 	},
		 	error: function (jqXHR, textStatus, errorThrown)
		    {
		 		console.log(errorThrown);
		 		console.log(jqXHR);
		    },
		    async:true,  
	 });
}

</script>	

{% endblock %}
